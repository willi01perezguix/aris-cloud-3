name: CI

on:
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: .
      DATABASE_URL: sqlite+pysqlite:///./ci.db

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Import check
        run: python -c "import app; print('ok')"

      - name: Alembic sanity
        run: |
          alembic heads
          python -c "import subprocess, sys; output = subprocess.check_output(['alembic','heads']).decode().strip().splitlines(); heads = [line for line in output if line.strip()]; sys.exit(f'Expected 1 alembic head, got {len(heads)}: {heads}') if len(heads) != 1 else None"
          alembic upgrade head

      - name: Run tests
        run: pytest -q

  test-postgres:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432/tcp
        options: >-
          --health-cmd "pg_isready -h 127.0.0.1 -p 5432 -U postgres -d postgres"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 30

    env:
      PYTHONPATH: .
      DB_HOST: 127.0.0.1
      DB_PORT: ${{ job.services.postgres.ports[5432] }}
      DB_NAME: postgres
      DB_USER: postgres
      DB_PASSWORD: postgres
      DATABASE_URL: postgresql+psycopg2://postgres:postgres@127.0.0.1:${{ job.services.postgres.ports[5432] }}/postgres

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Import check
        run: python -c "import app; print('ok')"

      - name: Wait for Postgres (auth + ready)
        run: |
          python - <<'PY'
          import os, time
          import psycopg2

          host = os.environ["DB_HOST"]
          port = int(os.environ["DB_PORT"])
          db   = os.environ["DB_NAME"]
          user = os.environ["DB_USER"]
          pwd  = os.environ["DB_PASSWORD"]

          last = None
          for _ in range(60):
              try:
                  conn = psycopg2.connect(
                      host=host, port=port, dbname=db, user=user, password=pwd, connect_timeout=2
                  )
                  with conn.cursor() as cur:
                      cur.execute("select current_user, current_database()")
                      print(cur.fetchone())
                  conn.close()
                  print("postgres ready/auth OK")
                  break
              except Exception as e:
                  last = e
                  time.sleep(1)
          else:
              raise SystemExit(f"postgres not ready/auth failed: {last}")
          PY

      - name: Alembic sanity
        run: |
          alembic heads
          python -c "import subprocess, sys; output = subprocess.check_output(['alembic','heads']).decode().strip().splitlines(); heads = [line for line in output if line.strip()]; sys.exit(f'Expected 1 alembic head, got {len(heads)}: {heads}') if len(heads) != 1 else None"
          alembic upgrade head

      - name: Run tests
        run: pytest -q
