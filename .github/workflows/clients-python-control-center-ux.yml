name: clients-python-control-center-ux

on:
  pull_request:
    branches: [main]
    paths:
      - 'clients/python/apps/control_center/**'
      - 'clients/python/tests/control_center/**'
      - '.github/workflows/clients-python-control-center-ux.yml'

jobs:
  control-center-ux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Packaging preflight
        run: |
          test -f clients/python/requirements.txt || (echo "Missing clients/python/requirements.txt" && exit 1)
          test -f clients/python/aris3_client_sdk/pyproject.toml || (echo "Missing SDK pyproject at clients/python/aris3_client_sdk/pyproject.toml" && exit 1)

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r clients/python/requirements.txt
          pip install -e ./clients/python/aris3_client_sdk[dev]

      - name: Lint (fail fast)
        run: ruff check clients/python/apps/control_center clients/python/tests/control_center --output-format=github

      - name: Type check (fail fast)
        run: |
          cd clients/python
          mypy apps/control_center shared

      - name: Control Center UX/access/users/settings tests
        run: |
          cd clients/python
          pytest -q \
            tests/control_center/ux \
            tests/control_center/access \
            tests/control_center/users \
            tests/control_center/settings

      - name: Build concise summary artifact
        if: always()
        run: |
          mkdir -p clients/python/artifacts
          {
            echo "workflow=clients-python-control-center-ux"
            echo "lint=ruff clients/python/apps/control_center clients/python/tests/control_center"
            echo "types=mypy apps/control_center shared"
            echo "tests=control_center/{ux,access,users,settings}"
          } > clients/python/artifacts/control_center_ux_summary.txt

      - name: Upload summary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: control-center-ux-summary
          path: clients/python/artifacts/control_center_ux_summary.txt
