name: clients-python-sdk

on:
  pull_request:
    branches: [main]
    paths:
      - 'clients/python/**'
      - '.github/workflows/clients-python-sdk.yml'
  workflow_dispatch:

jobs:
  sdk-quality:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: clients/python
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Validate Python client layout guardrails
        run: python scripts/ci/validate_python_client_layout.py
        working-directory: .
      - name: Install dependencies
        working-directory: .
        run: |
          python -m pip install --upgrade pip
          pip install -r ./clients/python/requirements.txt
          pip install -e ./clients/python/aris3_client_sdk
          pip install -e ./clients/python/aris_core_3_app
          pip install -e ./clients/python/aris_control_center_app
      - name: Lint
        run: |
          ruff check \
            aris3_client_sdk/src/aris3_client_sdk/http_client.py \
            aris3_client_sdk/src/aris3_client_sdk/auth_store.py \
            aris3_client_sdk/src/aris3_client_sdk/idempotency.py \
            aris3_client_sdk/src/aris3_client_sdk/error_mapper.py \
            aris3_client_sdk/src/aris3_client_sdk/tracing.py \
            aris3_client_sdk/src/aris3_client_sdk/clients/base.py \
            aris3_client_sdk/src/aris3_client_sdk/clients/auth.py \
            aris3_client_sdk/src/aris3_client_sdk/clients/stock_client.py \
            aris3_client_sdk/src/aris3_client_sdk/session.py \
            tests/test_sdk_hardening_day2.py
      - name: Type check
        run: |
          mypy --follow-imports=skip --disable-error-code=import-untyped \
            aris3_client_sdk/src/aris3_client_sdk/http_client.py \
            aris3_client_sdk/src/aris3_client_sdk/auth_store.py \
            aris3_client_sdk/src/aris3_client_sdk/idempotency.py \
            aris3_client_sdk/src/aris3_client_sdk/error_mapper.py \
            aris3_client_sdk/src/aris3_client_sdk/tracing.py \
            aris3_client_sdk/src/aris3_client_sdk/clients/base.py \
            aris3_client_sdk/src/aris3_client_sdk/clients/auth.py \
            aris3_client_sdk/src/aris3_client_sdk/clients/stock_client.py \
            aris3_client_sdk/src/aris3_client_sdk/session.py
      - name: Tests
        run: pytest tests -q
